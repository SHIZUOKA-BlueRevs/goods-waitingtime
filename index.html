<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待機列計測協力ボード</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 80%; max-width: 400px; text-align: center; }
        button { background: #007bff; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 1rem; }
        button:disabled { background: #ccc; }
        .hidden { display: none; }
        .status { margin-bottom: 1rem; font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>

<div class="card">
    <div id="step-start">
        <h2>グッズ列計測ボランティア</h2>
        <p>「並び始め」と「入店直前」にボタンを押すだけで、後から来る人の助けになります。ご協力いただけますか？</p>
        <div class="status">※個人情報は収集しません</div>
        <button onclick="startWaiting()">今から並び始める！</button>
    </div>

    <div id="step-waiting" class="hidden">
        <h2>計測中です...</h2>
        <p>列に並んでいただきありがとうございます。入店の直前になったら下のボタンを押してください。</p>
        <div class="status">（この画面は閉じても大丈夫です）</div>
        <button onclick="endWaiting()" style="background: #28a745;">入店します！</button>
    </div>

    <div id="step-thanks" class="hidden">
        <h2>ご協力感謝！</h2>
        <p>計測にご協力いただきありがとうございました！</p>
        <p>あなたのデータが、次の方の安心に繋がります。お買い物をお楽しみください！</p>
    </div>
</div>

<script>
    const SUB_URL = "https://uycmovhuawjneoicvdpb.supabase.co";
    const SUB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5Y21vdmh1YXdqbmVvaWN2ZHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxOTc4MzIsImV4cCI6MjA4Mzc3MzgzMn0.vQnxkNO9xNk2g1Yxs3nHVchgzU1FK_SHuCI9dVGNTjQ";
    const supabase = supabase.createClient(SUB_URL, SUB_KEY);

    let sessionId = localStorage.getItem('queue_session_id');

    // 画面切り替え関数
    function showStep(stepId) {
        ['step-start', 'step-waiting', 'step-thanks'].forEach(id => {
            document.getElementById(id).classList.toggle('hidden', id !== stepId);
        });
    }

    // ページ読み込み時の状態確認
    async function checkStatus() {
        if (!sessionId) {
            showStep('step-start');
            return;
        }
        const { data } = await supabase.from('queue_logs').select('*').eq('user_session_id', sessionId).single();
        if (data && data.is_completed) {
            showStep('step-thanks');
        } else if (data) {
            showStep('step-waiting');
        }
    }

    // 並び始め
    async function startWaiting() {
        const newId = crypto.randomUUID();
        const { error } = await supabase.from('queue_logs').insert([
            { user_session_id: newId, start_time: new Date().toISOString() }
        ]);
        if (!error) {
            localStorage.setItem('queue_session_id', newId);
            sessionId = newId;
            showStep('step-waiting');
        }
    }

    // 入店
    async function endWaiting() {
        const { error } = await supabase.from('queue_logs').update({ 
            end_time: new Date().toISOString(), 
            is_completed: true 
        }).eq('user_session_id', sessionId);
        
        if (!error) {
            showStep('step-thanks');
        }
    }

    checkStatus();
</script>
</body>
</html>
